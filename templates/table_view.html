{% extends "base.html" %}
{% block title %}Veri Tablosu{% endblock %}

{% block head %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.bootstrap5.min.css"/>
<style>
/* ---------- Genel Stil ---------- */
.filter-input {
    width: 100%;
    box-sizing: border-box;
    padding: 4px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.85rem;
}

#data_table, .alert, h2 { font-size: 0.9rem; }
h2 { font-size: 1.4rem !important; }

.dataTables_wrapper .dataTables_info,
.dataTables_wrapper .dataTables_length,
.dataTables_wrapper .dataTables_filter,
.dataTables_wrapper .dataTables_paginate {
    font-size: 0.85rem !important;
}

.table-hover tbody tr:hover { background-color: #f2f2f2; }
.table-responsive { overflow-x: auto; }
#data_table th:first-child, #data_table td:first-child { width: 32px; text-align: center; }

/* ---------- Butonlar ---------- */
#controls-left {
    display: flex !important;
    flex-direction: column !important; /* dikey yığın */
    align-items: flex-start !important;
    gap: 6px !important; /* butonlar arası dikey boşluk */
}

#colvis-container {
    display: inline-flex !important;
    justify-content: flex-start !important;
    align-items: center !important;
}

#controls-left .btn,
#colvis-container .btn,
.btn-success.btn-sm {
    font-size: 0.8rem !important;
    padding: 5px 10px !important;
    margin: 0 !important;
}

/* Mobil küçültme */
@media (max-width: 768px) {
    .filter-input { font-size: 0.8rem; padding: 3px; }
    #controls-left .btn, #colvis-container .btn { font-size: 0.75rem; padding: 3px 8px; }
}
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">2. Etiketlenecek Veri Tablosu</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
{% endif %}
{% endwith %}

<div class="alert alert-info" role="alert">
    **Gelişmiş Filtreleme:** Artık her sütunun altındaki kutucuktan ayrı ayrı filtreleme yapabilirsiniz.
</div>

<form method="POST" action="{{ url_for('table_view') }}">
    <!-- Butonlar -->
    <div id="controls-left" class="d-flex mb-3">
        <div id="colvis-container" class="btn-group"></div>
        <button type="submit" class="btn btn-success btn-sm" {% if not template_set %}disabled{% endif %}>
            <i class="bi bi-printer"></i>
            Seçilen {{ 'Satırları' if template_set else 'Satırları Seçin ve Yazdırın' }} Yazdırmaya Hazırla
        </button>
    </div>

    <div class="table-responsive">
        <table id="data_table" class="table table-striped table-hover table-sm" style="width:100%">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select_all"></th>
                    {% for col in columns %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th></th>
                    {% for col in columns %}
                    <th><input type="text" placeholder="{{ col }} filtrele" class="filter-input" data-column-index="{{ loop.index }}"></th>
                    {% endfor %}
                </tr>
            </tfoot>
            <tbody>
                {% for row in data %}
                <tr>
                    <td><input type="checkbox" name="selected_rows_checkbox" value="{{ loop.index0 }}"></td>
                    {% for cell in row %}
                    <td>{{ cell }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 
<script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.colVis.min.js"></script>

<script>
$(document).ready(function() {
    var table = $('#data_table').DataTable({
        order: [], 
        columnDefs: [
            { orderable: false, targets: 0 },
            { searchable: false, targets: 0 },
            { searchable: true, targets: '_all' }
        ],
        language: { url: "//cdn.datatables.net/plug-ins/2.0.8/i18n/tr.json" }
    });

    // ColVis butonunu al ve üstteki colvis-container içine koy
    table.buttons().container().appendTo('#colvis-container');

    // Sütun filtreleme
    $('.filter-input').on('keyup change', function() {
        var dt_index = $(this).data('column-index');
        table.column(dt_index).search(this.value, false, true).draw();
    });

    // Checkbox seçimi
    var selectedRows = new Set();
    $('#data_table tbody').on('change', 'input[name="selected_rows_checkbox"]', function() {
        var val = $(this).val();
        if (this.checked) selectedRows.add(val);
        else selectedRows.delete(val);
        updatePrintButton();
        updateSelectAllCheckbox();
    });

    $('#select_all').on('click', function() {
        var isChecked = this.checked;
        table.rows({search:'applied', page:'current'}).nodes().to$().find('input[name="selected_rows_checkbox"]').each(function() {
            this.checked = isChecked;
            var val = $(this).val();
            if (isChecked) selectedRows.add(val);
            else selectedRows.delete(val);
        });
        updatePrintButton();
    });

    function updateSelectAllCheckbox() {
        var visibleCheckboxes = table.rows({search:'applied', page:'current'}).nodes().to$().find('input[name="selected_rows_checkbox"]');
        var checkedCount = visibleCheckboxes.filter(':checked').length;
        $('#select_all').prop('checked', checkedCount>0 && checkedCount===visibleCheckboxes.length);
        $('#select_all').prop('indeterminate', checkedCount>0 && checkedCount<visibleCheckboxes.length);
    }

    $('form').on('submit', function(e){
        $('input[name="selected_rows"]').remove();
        selectedRows.forEach(function(val){
            $('<input>').attr({type:'hidden', name:'selected_rows', value:val}).appendTo('form');
        });
    });

    function updatePrintButton() {
        var btn = $('.btn-success[type="submit"]');
        var templateIsSet = {{ 'true' if template_set else 'false' }};
        if (selectedRows.size>0 && templateIsSet) {
            btn.prop('disabled', false).html('<i class="bi bi-printer"></i> Seçilen '+selectedRows.size+' Satırı Yazdırmaya Hazırla');
        } else if (templateIsSet) {
            btn.prop('disabled', true).html('<i class="bi bi-printer"></i> Seçilen Satırları Yazdırmaya Hazırla');
        } else {
            btn.prop('disabled', true).html('<i class="bi bi-printer"></i> Şablonu Ayarlayın');
        }
    }
    updatePrintButton();

    // draw sonrası checkbox durumunu koru
    table.on('draw', function() {
        table.rows({page:'current'}).nodes().to$().find('input[name="selected_rows_checkbox"]').each(function(){
            this.checked = selectedRows.has($(this).val());
        });
        updateSelectAllCheckbox();
    });
});
</script>
{% endblock %}
